<!DOCTYPE html>
<html lang="en">
	<head>
		<% include ../partials/head %>
	</head>
	<!-- console.log(name) This is for consoling of all jank, it will be in terminal hosting node. Remember to add the tags for this to w -->
	<body class="container">
		<header>
			<% include ../partials/header %>
		</header>
		<!-- console.log(matches) -->
		<main>
			<div class="container page rounded-bottom">
				<div class="messaging">
					<div class="inbox_msg">
						<div class="inbox_people">
							<div class="headind_srch">
								<div class="recent_heading">
									<h4>Your Matches</h4>
								</div>
								<div class="srch_bar">
									<div class="stylish-input-group">
										<!-- <input type="text" class="search-bar"  placeholder="Search" >
										<span class="input-group-addon">
										<button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
										</span> -->
									</div>
								</div>
							</div>
							<div class="inbox_chat">
								<% matches.forEach(person => { %>
								<div
									class="chat_list"
									onclick="initChat('<%= user._id %>', '<%= person._id %>')"
								>
									<div id="" class="chat_people">
										<div class="chat_img">
											<img
												src="<%= person.Prof%>"
												alt="profile pic"
											/>
										</div>
										<div class="chat_ib">
											<h5>
												<%= person.username%>
												<span class="chat_date"
													>todo</span
												>
											</h5>
											<!-- TODO: stuff-->
										</div>
									</div>
								</div>
								<% }) %>
							</div>
						</div>
						<div class="mesgs">
							<div class="msg_history" id="msg_history"></div>
							<div class="type_msg">
								<div class="input_msg_write">
									<input
										id="messagetosend"
										class="write_msg"
										placeholder="Type a message"
									/>
									<button
										id="send-button"
										class="msg_send_btn"
										type="submit"
									>
										send!
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>

		<footer>
			<% include ../partials/footer %>
		</footer>
		<!-- This shit must go somewhere. Julian help -->
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io(); //opening sockets
			var u1, u2;
			var roomname;

			function datestuffrename(newTime) {
				var date = new Date();
				var currentDate = new Date(newTime);
				var time = currentDate.toLocaleTimeString();
				var date = currentDate.getDate();
				var month = currentDate.getMonth();
				var year = currentDate.getFullYear();

				return month + 1 + "/" + date + "/" + year + " @ " + time;
			}

			function showMessage(msg) {
				var blockthing = document.createElement("div");
				blockthing.innerHTML =
					'<div class="incoming_msg">' +
					'<div class="received_msg">' +
					'<div class="received_withd_msg">' +
					"<p>" +
					msg.text +
					"</p>" +
					'<span class="time_date">' +
					datestuffrename(msg.date) +
					"</span></div>" +
					"</div>" +
					"</div>";

				var container = document.getElementById("msg_history");
				container.appendChild(blockthing);
				$("#msg_history")[0].scrollTop = $(
					"#msg_history"
				)[0].scrollHeight;
			}

			function initChat(id1, id2) {
				u1 = id1;
				u2 = id2;
				$("#msg_history").empty();
				socket.emit("init", { id1: id1, id2: id2 });
			}

			$(function() {
				socket.on("joined", result => {
					roomname = result.roomName;
					result.history.forEach(message => {
						showMessage(message);
					});
				});

				$(".chat_list").click(() => {
					// getElementById('')
					// $('.chat_list').attr('class', 'chat_list active_chat')
				});

				//send message
				$("#messagetosend").keypress(e => {
					if (e.which == 13) {
						e.preventDefault();
						sendmessage();
					}
				});
				$("#send-button").click(function(e) {
					e.preventDefault(); // prevents page reloading
					sendmessage();
					return false;
				});

				function sendmessage() {
					socket.emit(
						"chat message",
						roomname,
						"<%=user._id%>",
						$("#messagetosend").val()
					);
					$("#messagetosend").val("");
				}

				//receiving messages

				socket.on("chat message", function(msg) {
					showMessage(msg);
				});
			});
		</script>
	</body>
</html>
